name: Build and deploy .NET Core app to Windows WebApp bnk-myApp-vsarm-site
on:
  workflow_dispatch: # Run manually 
  push:
    branches:
    - 1.0-VSArm
env:
  APP_NAME: myIaC-arm-gha
  AZURE_RG_LOCATION: centralus
  AZURE_WEBAPP_PACKAGE_PATH: myApp/publish
  #AZURE_WEBAPP_PUBLISH_PROFILE: ${{ secrets.bnk_myApp_vsarm_site_47a1 }}
  CONFIGURATION: Release
  DOTNET_CORE_VERSION: 6.0.x
  WORKING_DIRECTORY: myApp
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.DOTNET_CORE_VERSION }}

    - name: Restore
      run: dotnet restore "${{ env.WORKING_DIRECTORY }}"

    - name: Build
      run: dotnet build "${{ env.WORKING_DIRECTORY }}" --configuration ${{ env.CONFIGURATION }} --no-restore

    - name: Test
      run: dotnet test "${{ env.WORKING_DIRECTORY }}" --no-build

    - name: Publish
      run: dotnet publish "${{ env.WORKING_DIRECTORY }}" --configuration ${{ env.CONFIGURATION }} --no-build --output "${{ env.AZURE_WEBAPP_PACKAGE_PATH }}"

      # Deploy Infrastructure
    - uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Setup AzureCLI
      run: |
        echo "ARM_SUBSCRIPTION_ID=$(az account show --query="id" -o tsv)" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=$(az account show --query="tenantId" -o tsv)" >> $GITHUB_ENV
        echo bnk-${{env.APP_NAME}}-rg
        echo "AZURE_RG=bnk-${{env.APP_NAME}}-rg" >> $GITHUB_ENV
        echo "AZURE_APP=bnk-${{env.APP_NAME}}-site" >> $GITHUB_ENV
        echo "AZURE_RG  ${{env.AZURE_RG}}"
        echo "AZURE_APP ${{env.AZURE_APP}}"
        pwd
        ls -la deploy/arm
        az group create --name ${{ env.AZURE_RG }} --location ${{ env.AZURE_RG_LOCATION }}
        echo "Azure resource group created"

      # Deploy ARM template
    - name: Run ARM deploy
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ env.AZURE_SUBSCRIPTION }}
        resourceGroupName: ${{ env.AZURE_RG }}
        template: ./deploy/arm/WebSite.json
        parameters: deploy/arm/WebSite.parameters.json appName=${{ env.APP_NAME }}

    # Deploy Code to Azure
    - name: Deploy to Azure WebApp
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_APP }}
        package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
        # publish-profile: ${{ env.AZURE_WEBAPP_PUBLISH_PROFILE }}

    - name: Publish Artifacts
      uses: actions/upload-artifact@v1.0.0
      with:
        name: webapp
        path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
